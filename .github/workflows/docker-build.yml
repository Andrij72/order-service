name: Build & Test Order Service

on:
  push:
    branches:
      - develop
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:

  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0.32
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Run unit + integration tests
        run: mvn clean verify

      - name: Build jar (skip tests)
        run: mvn clean package -DskipTests


  docker:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build & Push Docker image
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/order-service:latest


  e2e-tests:
    runs-on: ubuntu-latest
    needs: docker
    services:
      mysql:
        image: mysql:8.0.32
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      kafka:
        image: confluentinc/cp-kafka:7.5.0
        ports:
          - 9092:9092
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: "localhost:2181"
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

    steps:
      - name: Pull Order Service image
        run: docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/order-service:latest

      - name: Run Order Service container
        run: |
          docker run -d --name order-service \
            -p 8083:8083 \
            -e SPRING_PROFILES_ACTIVE=docker \
            -e MYSQL_USER=${{ secrets.MYSQL_USER }} \
            -e MYSQL_PASS=${{ secrets.MYSQL_PASSWORD }} \
            --network host \
            ${{ secrets.DOCKER_HUB_USERNAME }}/order-service:latest

      - name: Wait for service to be ready
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8083/actuator/health && break
            echo "Waiting for service..."
            sleep 5
          done

      - name: Run API tests
        run: |
          curl -v http://localhost:8083/api/orders || exit 1
